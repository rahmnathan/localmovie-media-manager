<html>
<head>
    <script type="text/javascript"
        src="//www.gstatic.com/cast/sdk/libs/caf_receiver/v3/cast_receiver_framework.js">
    </script>
</head>
<body>
    <cast-media-player></cast-media-player>
    <script>
        var context = cast.framework.CastReceiverContext.getInstance();
        var playerManager = context.getPlayerManager();
        var progressTimer = null;
        var currentUpdatePositionUrl = null;

        // Intercept LOAD to extract custom metadata BEFORE start()
        playerManager.setMessageInterceptor(
            cast.framework.messages.MessageType.LOAD,
            function(request) {
                console.log('LOAD intercepted');
                if (request.media && request.media.customData) {
                    currentUpdatePositionUrl = request.media.customData['update-position-url'];
                    console.log('Got update URL from customData:', currentUpdatePositionUrl);
                }
                if (request.media && request.media.metadata) {
                    var url = request.media.metadata['update-position-url'];
                    if (url) {
                        currentUpdatePositionUrl = url;
                        console.log('Got update URL from metadata:', currentUpdatePositionUrl);
                    }
                }
                return request;
            }
        );

        // Now start the receiver
        context.start();

        // Log errors
        playerManager.addEventListener(
            cast.framework.events.EventType.ERROR,
            function(event) { console.error('Player error:', event.detailedErrorCode, event.error); }
        );

        // Track state changes for progress saving
        playerManager.addEventListener(
            cast.framework.events.EventType.PLAYER_STATE_CHANGED,
            function(event) {
                console.log('Player state:', event.state);
                if (event.state === cast.framework.messages.PlayerState.PLAYING) {
                    startProgressTimer();
                } else {
                    stopProgressTimer();
                    if (event.state === cast.framework.messages.PlayerState.IDLE ||
                        event.state === cast.framework.messages.PlayerState.PAUSED) {
                        saveProgress();
                    }
                }
            }
        );

        function startProgressTimer() {
            if (progressTimer) return;
            console.log('Starting progress timer');
            progressTimer = setInterval(saveProgress, 10000);
        }

        function stopProgressTimer() {
            if (progressTimer) {
                console.log('Stopping progress timer');
                clearInterval(progressTimer);
                progressTimer = null;
            }
        }

        function saveProgress() {
            if (!currentUpdatePositionUrl) {
                console.log('No update URL, skipping save');
                return;
            }

            var positionSec = Math.floor(playerManager.getCurrentTimeSec());
            var durationMs = Math.floor(playerManager.getDurationSec() * 1000);

            var parts = currentUpdatePositionUrl.split('?');
            var baseUrl = parts[0];
            var query = parts[1] || '';

            var url = baseUrl + '/' + positionSec;
            url += query ? '?' + query + '&duration=' + durationMs : '?duration=' + durationMs;

            console.log('Saving progress:', positionSec, 'seconds to', url);
            fetch(url, { method: 'PATCH' })
                .then(function(r) { console.log('Progress saved, status:', r.status); })
                .catch(function(err) { console.error('Progress save error:', err); });
        }
    </script>
</body>
</html>
