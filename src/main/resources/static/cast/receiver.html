<html>
<head>
    <script type="text/javascript"
        src="//www.gstatic.com/cast/sdk/libs/caf_receiver/v3/cast_receiver_framework.js">
    </script>
    <style>
        #debug {
            position: fixed;
            top: 10px;
            left: 10px;
            background: rgba(0,0,0,0.9);
            color: #0f0;
            font-family: monospace;
            font-size: 18px;
            padding: 15px;
            z-index: 2147483647;
            max-width: 800px;
            max-height: 300px;
            overflow: hidden;
            pointer-events: none;
        }
    </style>
</head>
<body>
    <cast-media-player></cast-media-player>
    <div id="debug">Debug: Starting...</div>
    <script>
        var debugEl = document.getElementById('debug');
        var debugLines = [];
        function debug(msg) {
            debugLines.push(msg);
            if (debugLines.length > 8) debugLines.shift();
            debugEl.innerText = debugLines.join('\n');
        }

        var context = cast.framework.CastReceiverContext.getInstance();
        var playerManager = context.getPlayerManager();
        var progressTimer = null;
        var currentUpdatePositionUrl = null;

        debug('Receiver initialized');

        // Intercept LOAD to extract custom metadata BEFORE start()
        playerManager.setMessageInterceptor(
            cast.framework.messages.MessageType.LOAD,
            function(request) {
                debug('LOAD intercepted');
                debug('Media: ' + (request.media ? 'yes' : 'no'));
                debug('Metadata: ' + (request.media && request.media.metadata ? 'yes' : 'no'));

                if (request.media && request.media.metadata) {
                    var keys = Object.keys(request.media.metadata);
                    debug('Keys: ' + keys.join(', '));
                    var url = request.media.metadata['update-position-url'];
                    if (url) {
                        currentUpdatePositionUrl = url;
                        debug('URL found');
                        debug('Returning request...');
                    } else {
                        debug('No update-position-url');
                    }
                }
                debug('LOAD done');
                return request;
            }
        );

        playerManager.addEventListener(
            cast.framework.events.EventType.ERROR,
            function(event) { debug('ERROR: ' + event.detailedErrorCode); }
        );

        playerManager.addEventListener(
            cast.framework.events.EventType.PLAYER_STATE_CHANGED,
            function(event) {
                debug('State: ' + event.state);
                if (event.state === cast.framework.messages.PlayerState.PLAYING) {
                    startProgressTimer();
                } else {
                    stopProgressTimer();
                }
            }
        );

        context.start();
        debug('Receiver started');

        // Try an immediate save after 5 seconds as a test
        setTimeout(function() {
            debug('5s test...');
            if (currentUpdatePositionUrl) {
                debug('Has URL, saving...');
                saveProgress();
            } else {
                debug('No URL after 5s');
            }
        }, 5000);

        function startProgressTimer() {
            if (progressTimer) return;
            debug('Timer started');
            progressTimer = setInterval(saveProgress, 10000);
        }

        function stopProgressTimer() {
            if (progressTimer) {
                clearInterval(progressTimer);
                progressTimer = null;
            }
        }

        function saveProgress() {
            if (!currentUpdatePositionUrl) {
                debug('Save skipped: no URL');
                return;
            }

            var positionSec = Math.floor(playerManager.getCurrentTimeSec());
            var durationMs = Math.floor(playerManager.getDurationSec() * 1000);

            var parts = currentUpdatePositionUrl.split('?');
            var baseUrl = parts[0];
            var query = parts[1] || '';

            var url = baseUrl + '/' + positionSec;
            url += query ? '?' + query + '&duration=' + durationMs : '?duration=' + durationMs;

            debug('Saving: ' + positionSec + 's');
            fetch(url, { method: 'PATCH' })
                .then(function(r) { debug('Saved: ' + r.status); })
                .catch(function(err) { debug('Save err: ' + err.message); });
        }
    </script>
</body>
</html>
