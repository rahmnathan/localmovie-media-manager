<html>
<head>
    <script type="text/javascript"
        src="//www.gstatic.com/cast/sdk/libs/caf_receiver/v3/cast_receiver_framework.js">
    </script>
</head>
<body>
    <cast-media-player></cast-media-player>
    <script>
        var context = cast.framework.CastReceiverContext.getInstance();
        var playerManager = context.getPlayerManager();
        var currentUpdatePositionUrl = null;
        var progressInterval = null;

        // Intercept LOAD to extract custom metadata
        playerManager.setMessageInterceptor(
            cast.framework.messages.MessageType.LOAD,
            function(request) {
                console.log('LOAD intercepted');

                if (request.media && request.media.metadata) {
                    var url = request.media.metadata['update-position-url'];
                    if (url) {
                        currentUpdatePositionUrl = url;
                        console.log('Update position URL:', url);
                    }
                }

                return request;
            }
        );

        context.start();

        // Register event listeners after start()
        playerManager.addEventListener(
            cast.framework.events.EventType.PLAYING,
            function() {
                console.log('Playback started');
                startProgressTimer();
            }
        );

        playerManager.addEventListener(
            cast.framework.events.EventType.PAUSE,
            function() {
                console.log('Playback paused');
                saveProgress();
                stopProgressTimer();
            }
        );

        playerManager.addEventListener(
            cast.framework.events.EventType.ENDED,
            function() {
                console.log('Playback ended');
                saveProgress();
                stopProgressTimer();
            }
        );

        function startProgressTimer() {
            if (progressInterval) return;
            console.log('Starting progress timer');
            // Save immediately, then every 10 seconds
            saveProgress();
            progressInterval = setInterval(saveProgress, 10000);
        }

        function stopProgressTimer() {
            if (progressInterval) {
                console.log('Stopping progress timer');
                clearInterval(progressInterval);
                progressInterval = null;
            }
        }

        function saveProgress() {
            if (!currentUpdatePositionUrl) return;

            var positionSec = Math.floor(playerManager.getCurrentTimeSec());
            var durationMs = Math.floor(playerManager.getDurationSec() * 1000);

            var parts = currentUpdatePositionUrl.split('?');
            var baseUrl = parts[0];
            var query = parts[1] || '';

            var url = baseUrl + '/' + positionSec;
            url += query ? '?' + query + '&duration=' + durationMs : '?duration=' + durationMs;

            console.log('Saving progress:', positionSec, 'seconds');
            fetch(url, { method: 'PATCH' })
                .then(function(r) { console.log('Progress saved:', r.status); })
                .catch(function(err) { console.error('Progress save error:', err); });
        }
    </script>
</body>
</html>
